<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Damien Couroussé - deploying site sources from hakyll to github.io</title>
<meta name="description" content="damien dot courousse dot fr">
<meta name="author" content="Damien Couroussé">

<li><link rel="stylesheet" href="../assets/css/pure-min.css"></li>
<li><link rel="stylesheet" href="../assets/css/side-menu.css"></li>
<li><link rel="stylesheet" href="../assets/css/main.css"></li>

</head>
<body>
    <div id="layout">
        <!-- Menu toggle -->
        <a href="#menu" id="menuLink" class="menu-link">
        </a>
        <div id="menu">
            <div class="pure-menu pure-menu-open">
                <a class="pure-menu-heading" href="../index.html">Home</a>

                <ul>
                    <!-- <li><a href="/about.html">About</a></li> -->
                    <!-- <li><a href="/contact.html">Contact</a></li> -->
                    <li><a href="../publications.html">Publications</a></li>
                    <li><a href="../posts.html">Posts</a></li>
                    <li><a href="../sw.html">Software</a></li>
                    <!-- <li><a href="/test.html">Test</a></li> -->
                </ul>
            </div>
        </div>

        <div id="main">
            <div class="header">
                <h1>deploying site sources from hakyll to github.io</h1>
                <!--<h2>A subtitle for your page goes here</h2>-->
            </div>

            <div class="content">
                <!--<h2 class="content-subhead">deploying site sources from hakyll to github.io</h2>-->
                <div class="content">
    Posted on November 27, 2014
    
</div>

<p>All blog posts that explain how to publish your site sources to github.io from a Hakyll build suggest to use the <code>_site</code> directory as a git submodule.</p>
<p>After a few experiments, I came to the conclusion that doing this can lead to some troubles.</p>
<p>I detail in this post why, and the workaround I use instead.</p>
<p>Most of the times, you build your site sources with:</p>
<pre class="example"><code>cabal run build
</code></pre>
<p>and all is perfect. The directory <code>_site</code> is updated and, in case you declared it as a submodule, and furthermore that you took previously the precaution no to be on a detached state in this submodule, everything is fine and the contents of the submodule are correctly updated.</p>
<p>Imagine now that you run instead:</p>
<pre class="example"><code>cabal run rebuild
</code></pre>
<p>In this case, you can notice that hakyll first wipes out the directories <code>_cache</code> and <code>_site</code>. What happens then? git-submodule is now wrecked out, and the directory <code>_site</code> is considered as a standard subdirectory in your source tree instead of a submodule! Indeed, if you go in the directory <code>_site</code> and for example run <code>git remote -v</code>, you will see that <code>origin</code> points to the location of you Hakyll source tree, not to the location of your <code>github.io</code> repository where you push the source site files!</p>
<p>Why did it happen? Because the <code>rebuild</code> process first involves the deletion of the <code>_site</code> directory.</p>
<p>Hopefully you can recover from this situation. Go to the Hakyll source tree and run:</p>
<pre class="example"><code>git submodule udpate --remote
</code></pre>
<p>To avoid this problem, it is necessary to use two separate directories for <code>_site</code> and your submodule directory. Once the Hakyll build/rebuild process is done, just copy the files from <code>_site</code> into your submodule directory (first checkout to the default branch!).</p>
<p>I pushed all of this in a minimalist <code>Makefile</code> (my submodule lies in <code>site</code>):</p>
<pre class="example"><code>.PHONY: build rebuild watch
build:
	cabal run $@
rebuild:
	cabal run $@
watch:
	cabal run $@

push: rebuild
	git submodule update --remote --merge
	cd site \
		&amp;&amp; git checkout master \
		&amp;&amp; rsync -avr --delete ../_site/* ./ \
		&amp;&amp; git add . \
		&amp;&amp; git commit -m 'site update' \
		&amp;&amp; git push origin master
	git add site
	git commit -m 'site update'
</code></pre>

            </div> <!-- /content -->
        </div> <!-- /main -->

        <div class="footer">
            <div class="pure-g">
                <div class="pure-u-1 u-sm-1-2">
                    Site generated by
                    <a href="http://jaspervdj.be/hakyll">Hakyll</a>
					and
                    <a href="http://johnmacfarlane.net/pandoc">pandoc</a>
                </div>
            </div>
        </div>

    </div> <!-- /layout -->

    <script src="../assets/js/ui.js"></script>

</body>
</html>
